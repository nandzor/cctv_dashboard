# ðŸ“Š CCTV Dashboard - Sequence Diagrams

**Technology Stack:**

- **Backend**: Laravel 10+ (PHP 8.2+)
- **Frontend**: Laravel Blade Templates
- **Interactivity**: Alpine.js
- **Real-time**: Laravel Echo + Pusher/WebSockets
- **API**: Laravel API Resources
- **Queue**: Laravel Queue (Database)

## ðŸ”„ Key Workflow Sequence Diagrams

### **1. Company Group Management Workflow (Admin Only)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Admin     â”‚  â”‚   Blade     â”‚  â”‚  Laravel    â”‚  â”‚  Database   â”‚  â”‚ WebSocket   â”‚
â”‚   User      â”‚  â”‚ Template    â”‚  â”‚ Controller  â”‚  â”‚             â”‚  â”‚   Server    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚ 1. Group Management Request     â”‚                â”‚                â”‚
       â”‚ (Create/Update/Delete Group)    â”‚                â”‚                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 2. POST/PUT/DELETE /groups     â”‚                â”‚
       â”‚                â”‚ Form Data: {province_code,     â”‚                â”‚
       â”‚                â”‚  province_name, group_name,    â”‚                â”‚
       â”‚                â”‚  address, status}              â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 3. Validate Admin Access        â”‚
       â”‚                â”‚                â”‚ - Check admin role              â”‚
       â”‚                â”‚                â”‚ - Verify permissions            â”‚
       â”‚                â”‚                â”‚ - Log admin action              â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 4. Group CRUD Operations        â”‚
       â”‚                â”‚                â”‚ - Validate province_code unique â”‚
       â”‚                â”‚                â”‚ - Check for associated branches  â”‚
       â”‚                â”‚                â”‚ - Save to company_groups         â”‚
       â”‚                â”‚                â”‚ - Update timestamps             â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 5. Branch Association           â”‚
       â”‚                â”‚                â”‚ - View associated branches       â”‚
       â”‚                â”‚                â”‚ - Add/remove branches           â”‚
       â”‚                â”‚                â”‚ - Update branch-group relations  â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 6. Group Validation             â”‚
       â”‚                â”‚                â”‚ - Verify province code unique   â”‚
       â”‚                â”‚                â”‚ - Check branch associations     â”‚
       â”‚                â”‚                â”‚ - Validate contact information   â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 7. Group Response               â”‚
       â”‚                â”‚                â”‚ - Group ID returned             â”‚
       â”‚                â”‚                â”‚ - Associated branches count     â”‚
       â”‚                â”‚                â”‚ - Status confirmation           â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 8. Return to Blade View         â”‚                â”‚
       â”‚                â”‚ - Redirect to groups.index      â”‚                â”‚
       â”‚                â”‚ - With success message          â”‚                â”‚
       â”‚                â”‚ - Flash session data            â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 9. Broadcast Group Change       â”‚                â”‚
       â”‚                â”‚ - WebSocket: group_updated      â”‚                â”‚
       â”‚                â”‚ - Data: {group_id, status}      â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚ 10. Notify All Clientsâ”‚
       â”‚                â”‚                â”‚                â”‚ - Group change event â”‚
       â”‚                â”‚                â”‚                â”‚ - Update UI componentsâ”‚
       â”‚                â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 11. Render Blade View           â”‚                â”‚                â”‚
       â”‚                â”‚ - Load groups.index.blade.php   â”‚                â”‚                â”‚
       â”‚                â”‚ - Display success toast         â”‚                â”‚                â”‚
       â”‚                â”‚ - Alpine.js updates list        â”‚                â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
```

### **2. Person Detection & Re-Identification Processing**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Device    â”‚  â”‚   System    â”‚  â”‚  Database   â”‚  â”‚  WhatsApp   â”‚  â”‚   Client    â”‚
â”‚  (Camera)   â”‚  â”‚   API       â”‚  â”‚             â”‚  â”‚  Provider   â”‚  â”‚ Dashboard   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚ 1. Person Detection                            â”‚                â”‚
       â”‚ (re_id, confidence, bbox)      â”‚                â”‚                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 2. POST /api/detection/log     â”‚                â”‚
       â”‚                â”‚ {re_id, branch_id, device_id,  â”‚                â”‚
       â”‚                â”‚  detected_count, detection_data}                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 3. Process Re-ID (Person)       â”‚
       â”‚                â”‚                â”‚ - Check re_id_master            â”‚
       â”‚                â”‚                â”‚ - Create if not exists          â”‚
       â”‚                â”‚                â”‚ - Update appearance_features    â”‚
       â”‚                â”‚                â”‚ - Update timestamps             â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 4. Log Detection                â”‚
       â”‚                â”‚                â”‚ - re_id_branch_detection        â”‚
       â”‚                â”‚                â”‚ - Multiple records per day OK   â”‚
       â”‚                â”‚                â”‚ - Save detection_timestamp      â”‚
       â”‚                â”‚                â”‚ - Save detection_data (JSON)    â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 5. Check Event Settings         â”‚
       â”‚                â”‚                â”‚ - branch_event_settings         â”‚
       â”‚                â”‚                â”‚ - WHERE branch_id + device_id   â”‚
       â”‚                â”‚                â”‚ - Get whatsapp_enabled (bool)   â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 6. Create Event Log             â”‚
       â”‚                â”‚                â”‚ - event_logs table              â”‚
       â”‚                â”‚                â”‚ - branch_id, device_id, re_id   â”‚
       â”‚                â”‚                â”‚ - Set notification flags        â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 7. Send WhatsApp (if enabled)   â”‚
       â”‚                â”‚                â”‚ - Get whatsapp_numbers (JSON)   â”‚
       â”‚                â”‚                â”‚ - Format message template       â”‚
       â”‚                â”‚                â”‚ - Call provider API             â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 8. Provider Response            â”‚
       â”‚                â”‚                â”‚ - Fire & forget (no tracking)   â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 9. Update Flags                 â”‚
       â”‚                â”‚                â”‚ - notification_sent = true      â”‚
       â”‚                â”‚                â”‚ - image_sent = true/false       â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 10. Response   â”‚                â”‚                â”‚
       â”‚                â”‚ {success: true, data: {         â”‚                â”‚
       â”‚                â”‚  re_id, branch_count: 1,        â”‚                â”‚
       â”‚                â”‚  total_detection_count}}        â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 11. WebSocket Update            â”‚                â”‚
       â”‚                â”‚ - Real-time dashboard update    â”‚                â”‚
       â”‚                â”‚ - Person tracking update        â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
```

### **3. CCTV Stream Request & Display**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User      â”‚  â”‚   Blade     â”‚  â”‚  Laravel    â”‚  â”‚  Database   â”‚  â”‚  Stream     â”‚
â”‚ Browser     â”‚  â”‚ Template    â”‚  â”‚ Controller  â”‚  â”‚             â”‚  â”‚  Server     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚ 1. Select Stream                â”‚                â”‚                â”‚
       â”‚ (Position 1, Branch A)          â”‚                â”‚                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 2. GET /api/stream/branch/1    â”‚                â”‚
       â”‚                â”‚ ?position=1                    â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 3. Query Streams                â”‚
       â”‚                â”‚                â”‚ - cctv_streams                  â”‚
       â”‚                â”‚                â”‚ - WHERE branch_id=1, position=1 â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 4. Stream Config                â”‚
       â”‚                â”‚                â”‚ {stream_url, credentials,       â”‚
       â”‚                â”‚                â”‚  resolution, fps}               â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 5. Validate & Decrypt           â”‚
       â”‚                â”‚                â”‚ - Check user permissions        â”‚
       â”‚                â”‚                â”‚ - Decrypt stream credentials    â”‚
       â”‚                â”‚                â”‚ - Build authenticated URL       â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 6. Stream Response              â”‚                â”‚
       â”‚                â”‚ {stream_url, status, quality}   â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 7. Initialize Video Player      â”‚                â”‚
       â”‚                â”‚ - Alpine.js initializes player  â”‚                â”‚
       â”‚                â”‚ - Load stream URL               â”‚                â”‚
       â”‚                â”‚ - Set video element source      â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 8. Connect to Stream            â”‚                â”‚
       â”‚                â”‚ - WebRTC/RTSP/HLS connection    â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 9. Stream Data                  â”‚                â”‚
       â”‚                â”‚ - Video frames                  â”‚                â”‚
       â”‚                â”‚ - Audio (if available)          â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 10. Display Stream              â”‚                â”‚
       â”‚                â”‚ - Render video in grid          â”‚                â”‚
       â”‚                â”‚ - Show stream info              â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 11. Health Check (Periodic)     â”‚
       â”‚                â”‚                â”‚ - Ping stream endpoint          â”‚
       â”‚                â”‚                â”‚ - Update stream status          â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 12. Status Updates              â”‚                â”‚
       â”‚                â”‚ - Stream quality indicators     â”‚                â”‚
       â”‚                â”‚ - Connection status             â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
```

### **4. API Credential Creation & Usage**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Admin     â”‚  â”‚   Blade     â”‚  â”‚  Laravel    â”‚  â”‚  Database   â”‚  â”‚  External   â”‚
â”‚   User      â”‚  â”‚ Template    â”‚  â”‚ Controller  â”‚  â”‚             â”‚  â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚ 1. Create API Key               â”‚                â”‚                â”‚
       â”‚ (Branch: Jakarta, Permissions)  â”‚                â”‚                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 2. POST /api/credentials        â”‚                â”‚
       â”‚                â”‚ Form: {name, branch_id,        â”‚                â”‚
       â”‚                â”‚  permissions, rate_limit,      â”‚                â”‚
       â”‚                â”‚  expires_at}                   â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 3. Validate Input               â”‚
       â”‚                â”‚                â”‚ - Check admin permissions       â”‚
       â”‚                â”‚                â”‚ - Validate branch access        â”‚
       â”‚                â”‚                â”‚ - Verify permission format      â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 4. Generate Credentials         â”‚
       â”‚                â”‚                â”‚ - Generate unique API key       â”‚
       â”‚                â”‚                â”‚ - Generate API secret           â”‚
       â”‚                â”‚                â”‚ - Encrypt secret                â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 5. Save to Database             â”‚
       â”‚                â”‚                â”‚ - api_credentials table         â”‚
       â”‚                â”‚                â”‚ - Set created_by                â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 6. Success Response             â”‚
       â”‚                â”‚                â”‚ {api_key, api_secret, id}       â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 7. Render Blade View            â”‚                â”‚
       â”‚                â”‚ - Display API key (one-time)    â”‚                â”‚
       â”‚                â”‚ - Display secret (one-time)     â”‚                â”‚
       â”‚                â”‚ - Alpine.js copy to clipboard   â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 8. External API Request         â”‚
       â”‚                â”‚                â”‚ GET /api/counting/summary       â”‚
       â”‚                â”‚                â”‚ Headers: X-API-Key: xxx         â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 9. Authenticate Request         â”‚
       â”‚                â”‚                â”‚ - Validate API key              â”‚
       â”‚                â”‚                â”‚ - Check permissions             â”‚
       â”‚                â”‚                â”‚ - Verify rate limits            â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 10. Log Request                 â”‚
       â”‚                â”‚                â”‚ - api_request_logs              â”‚
       â”‚                â”‚                â”‚ - Update last_used_at           â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 11. Process Request             â”‚
       â”‚                â”‚                â”‚ - Query counting data           â”‚
       â”‚                â”‚                â”‚ - Generate response             â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 12. API Response                â”‚
       â”‚                â”‚                â”‚ {success: true, data: {...}}    â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 13. Update Usage Stats          â”‚
       â”‚                â”‚                â”‚ - Increment request count       â”‚
       â”‚                â”‚                â”‚ - Update response time          â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
```

### **5. Report Generation Workflow**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User      â”‚  â”‚   Blade     â”‚  â”‚  Laravel    â”‚  â”‚  Database   â”‚
â”‚             â”‚  â”‚ Template    â”‚  â”‚ Controller  â”‚  â”‚ (PostgreSQL)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â”‚ 1. Request Report               â”‚                â”‚
       â”‚ (Daily, Branch Jakarta)         â”‚                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 2. GET /reports/generate        â”‚                â”‚
       â”‚                â”‚ Query: {type: "daily",         â”‚                â”‚
       â”‚                â”‚  date: "2024-01-16",           â”‚                â”‚
       â”‚                â”‚  branch_id: 1, format: "pdf"}  â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 3. Check Cached Report          â”‚
       â”‚                â”‚                â”‚ - counting_reports table        â”‚
       â”‚                â”‚                â”‚ - WHERE report_type, date,      â”‚
       â”‚                â”‚                â”‚   branch_id                     â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 4. Report Found/Not Found       â”‚
       â”‚                â”‚                â”‚ - Existing: Return cached       â”‚
       â”‚                â”‚                â”‚ - Not exists: Generate new      â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 5. Query Raw Data (if needed)   â”‚
       â”‚                â”‚                â”‚ - re_id_branch_detection        â”‚
       â”‚                â”‚                â”‚ - event_logs                    â”‚
       â”‚                â”‚                â”‚ - device_master                 â”‚
       â”‚                â”‚                â”‚ - company_branches              â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 6. Calculate Statistics         â”‚
       â”‚                â”‚                â”‚ - Total detections              â”‚
       â”‚                â”‚                â”‚ - Total events                  â”‚
       â”‚                â”‚                â”‚ - Unique persons (Re-ID)        â”‚
       â”‚                â”‚                â”‚ - Performance metrics           â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 7. Save Report                  â”‚
       â”‚                â”‚                â”‚ - Save to counting_reports      â”‚
       â”‚                â”‚                â”‚ - Set generated_at              â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 8. Generate Response            â”‚
       â”‚                â”‚                â”‚ - Format data                   â”‚
       â”‚                â”‚                â”‚ - Prepare charts data           â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 9. Return Blade View/PDF        â”‚                â”‚
       â”‚                â”‚ - Render reports.show.blade     â”‚                â”‚
       â”‚                â”‚ - Or download PDF file          â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 10. Display Report              â”‚                â”‚
       â”‚                â”‚ - Chart.js renders charts       â”‚                â”‚
       â”‚                â”‚ - Alpine.js table interactions  â”‚                â”‚
       â”‚                â”‚ - Export buttons                â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
```

### **6. CCTV Layout Management Workflow (Admin Only)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Admin     â”‚  â”‚   Blade     â”‚  â”‚  Laravel    â”‚  â”‚  Database   â”‚  â”‚ WebSocket   â”‚
â”‚   User      â”‚  â”‚ Template    â”‚  â”‚ Controller  â”‚  â”‚             â”‚  â”‚   Server    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚ 1. Create Layout Request        â”‚                â”‚                â”‚
       â”‚ (4-window, positions config)    â”‚                â”‚                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 2. POST /layouts                â”‚                â”‚
       â”‚                â”‚ Form: {layout_name, layout_type,â”‚                â”‚
       â”‚                â”‚  positions: [{branch_id,       â”‚                â”‚
       â”‚                â”‚   device_id, position_name}]}  â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 3. Validate Admin Access        â”‚
       â”‚                â”‚                â”‚ - Check admin role              â”‚
       â”‚                â”‚                â”‚ - Verify permissions            â”‚
       â”‚                â”‚                â”‚ - Log admin action              â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 4. Create Layout                â”‚
       â”‚                â”‚                â”‚ - Save to cctv_layout_settings  â”‚
       â”‚                â”‚                â”‚ - Validate layout type         â”‚
       â”‚                â”‚                â”‚ - Set created_by               â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 5. Configure Positions         â”‚
       â”‚                â”‚                â”‚ - Save to cctv_position_settingsâ”‚
       â”‚                â”‚                â”‚ - Validate branch/device        â”‚
       â”‚                â”‚                â”‚ - Set position settings        â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 6. Layout Created               â”‚
       â”‚                â”‚                â”‚ - Layout ID returned            â”‚
       â”‚                â”‚                â”‚ - Position count confirmed      â”‚
       â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 7. Redirect to Blade View       â”‚                â”‚
       â”‚                â”‚ - Redirect to layouts.index     â”‚                â”‚
       â”‚                â”‚ - With success flash message    â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 8. Set Default Layout (Optional)â”‚                â”‚
       â”‚                â”‚ POST /layouts/{id}/set-default  â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 9. Update Default              â”‚
       â”‚                â”‚                â”‚ - Unset previous default        â”‚
       â”‚                â”‚                â”‚ - Set new default layout        â”‚
       â”‚                â”‚                â”‚ - Update user preferences       â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚ 10. Broadcast Layout Change     â”‚
       â”‚                â”‚                â”‚ - WebSocket: layout_updated      â”‚
       â”‚                â”‚                â”‚ - Data: {layout_id, is_default} â”‚
       â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚ 11. Notify All Clientsâ”‚
       â”‚                â”‚                â”‚                â”‚ - Layout change event â”‚
       â”‚                â”‚                â”‚                â”‚ - Update UI componentsâ”‚
       â”‚                â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 12. Render Blade View           â”‚                â”‚                â”‚
       â”‚                â”‚ - Load layouts.index.blade      â”‚                â”‚                â”‚
       â”‚                â”‚ - Display success toast         â”‚                â”‚                â”‚
       â”‚                â”‚ - Alpine.js updates UI          â”‚                â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
```

### **7. Real-time Dashboard Updates**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Device    â”‚  â”‚   API       â”‚  â”‚  Database   â”‚  â”‚ WebSocket   â”‚  â”‚   Client    â”‚
â”‚  (Camera)   â”‚  â”‚   Server    â”‚  â”‚             â”‚  â”‚   Server    â”‚  â”‚ Dashboard   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚ 1. Detection Event              â”‚                â”‚                â”‚
       â”‚ (New detection: count=5)        â”‚                â”‚                â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 2. Process & Save              â”‚                â”‚
       â”‚                â”‚ - Update detection logs        â”‚                â”‚
       â”‚                â”‚ - Update device totals         â”‚                â”‚
       â”‚                â”‚ - Create event log             â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 3. Database Updated            â”‚                â”‚
       â”‚                â”‚ - All tables updated           â”‚                â”‚
       â”‚                â”‚ - Statistics recalculated      â”‚                â”‚
       â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 4. Broadcast Update            â”‚                â”‚
       â”‚                â”‚ - WebSocket channel: dashboard â”‚                â”‚
       â”‚                â”‚ - Event: detection_update      â”‚                â”‚
       â”‚                â”‚ - Data: {device_id, count,     â”‚                â”‚
       â”‚                â”‚   branch_id, timestamp}        â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚ 5. Broadcast to Clientsâ”‚
       â”‚                â”‚                â”‚                â”‚ - All connected clientsâ”‚
       â”‚                â”‚                â”‚                â”‚ - Dashboard subscribersâ”‚
       â”‚                â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚ 6. Update UI
       â”‚                â”‚                â”‚                â”‚                â”‚ - Update statisticsâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚ - Refresh charts  â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚ - Show notificationâ”‚
       â”‚                â”‚                â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 7. WhatsApp Notification       â”‚                â”‚                â”‚
       â”‚                â”‚ - Send to configured numbers   â”‚                â”‚                â”‚
       â”‚                â”‚ - Track delivery status        â”‚                â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 8. Notification Status Update  â”‚                â”‚                â”‚
       â”‚                â”‚ - WhatsApp delivered/read      â”‚                â”‚                â”‚
       â”‚                â”‚ - Update notification status   â”‚                â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚ 9. Broadcast Notification Update                â”‚                â”‚
       â”‚                â”‚ - WebSocket: notification_update                â”‚                â”‚
       â”‚                â”‚ - Data: {event_id, status}     â”‚                â”‚                â”‚
       â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚                â”‚ 10. Update Notification UIâ”‚
       â”‚                â”‚                â”‚                â”‚ - Show delivery status â”‚
       â”‚                â”‚                â”‚                â”‚ - Update notification listâ”‚
       â”‚                â”‚                â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
```

## ðŸ“Š Sequence Diagram Summary

### **Key Interactions:**

1. **Company Group Management Flow (Admin Only)**

   - Admin â†’ Frontend â†’ API â†’ Database â†’ WebSocket â†’ All Clients
   - Group creation, update, deletion
   - Branch association management
   - Real-time group updates and notifications

2. **Person Detection Flow (Re-ID Based)**

   - Device â†’ API â†’ Re-ID Master â†’ Detection Log â†’ Event Log â†’ WhatsApp â†’ Client
   - Real-time person re-identification and tracking
   - Multiple detection records per person per day
   - Fire & forget WhatsApp notifications

3. **CCTV Stream Flow**

   - Client â†’ API â†’ Database â†’ Stream Server â†’ Display
   - Device-based stream management
   - Authentication, validation, and health monitoring

4. **API Management Flow**

   - Admin â†’ Frontend â†’ API â†’ Database â†’ External Client
   - Complete credential lifecycle management
   - Device and Re-ID scoping support

5. **Report Generation Flow**

   - User â†’ Blade â†’ Controller â†’ Database (counting_reports) â†’ Response
   - Database-stored reports (counting_reports table)
   - Materialized views for complex queries
   - Person tracking analytics

6. **CCTV Layout Management Flow (Admin Only)**

   - Admin â†’ Frontend â†’ API â†’ Database â†’ WebSocket â†’ All Clients
   - Layout creation and position configuration
   - Real-time layout updates and notifications
   - Admin-controlled layout switching

7. **Real-time Updates Flow**
   - Device â†’ API â†’ Database â†’ WebSocket â†’ All Clients
   - Live dashboard updates and notifications
   - Person tracking updates
   - Detection count updates
   - Layout change notifications
   - Group change notifications

### **Performance Optimizations:**

- **Database Caching**: PostgreSQL materialized views for complex queries
- **Async Processing**: Background jobs with retry mechanism (Database Queue)
- **WebSocket**: Real-time updates without polling (Laravel Echo)
- **Database Transactions**: ACID compliance with deadlock retry
- **Read/Write Splitting**: Separate read and write connections
- **Composite Indexes**: Optimized multi-column indexes (GIN, B-tree, partial)
- **Eager Loading**: Prevent N+1 query problems
- **Rate Limiting**: Per-credential and per-IP throttling
- **Connection Pooling**: PgBouncer for PostgreSQL

### **Error Handling:**

- **Validation**: Form Requests with comprehensive rules
- **Fallbacks**: Materialized view refresh, retry mechanisms (3 attempts)
- **Monitoring**: Health checks, status tracking, performance metrics
- **Logging**: Comprehensive audit trails (Laravel logs + database logs)
- **Transactions**: Automatic rollback on errors
- **Failed Jobs**: Queue failed job handling with notifications

### **Frontend Architecture (Laravel Blade + Alpine.js):**

#### **Blade Components:**

```php
// resources/views/components/button.blade.php
@props(['variant' => 'primary', 'type' => 'button'])

<button type="{{ $type }}"
    {{ $attributes->merge(['class' => "btn btn-{$variant}"]) }}>
    {{ $slot }}
</button>
```

#### **Alpine.js Integration:**

```html
<!-- resources/views/groups/index.blade.php -->
<div
  x-data="{ 
    showModal: false, 
    selectedGroup: null,
    deleteGroup(id) {
        this.selectedGroup = id;
        this.showModal = true;
    }
}"
>
  <!-- Group list with Alpine.js interactivity -->
  <button @click="deleteGroup({{ $group->id }})">Delete</button>

  <!-- Modal component -->
  <x-modal x-show="showModal" @close="showModal = false">
    <!-- Modal content -->
  </x-modal>
</div>
```

#### **Real-time Updates with Laravel Echo:**

```javascript
// resources/js/app.js
import Echo from "laravel-echo";
import Pusher from "pusher-js";

window.Pusher = Pusher;
window.Echo = new Echo({
  broadcaster: "pusher",
  key: import.meta.env.VITE_PUSHER_APP_KEY,
  cluster: import.meta.env.VITE_PUSHER_APP_CLUSTER,
});

// Listen for real-time updates
Echo.channel("dashboard").listen("GroupUpdated", (e) => {
  // Alpine.js updates UI
  Alpine.store("groups").refresh();
});
```

#### **Chart.js Integration:**

```html
<!-- resources/views/dashboard/index.blade.php -->
<canvas id="detectionChart" x-data="chartComponent()"></canvas>

<script>
  function chartComponent() {
      return {
          chart: null,
          init() {
              const ctx = document.getElementById('detectionChart');
              this.chart = new Chart(ctx, {
                  type: 'line',
                  data: @json($chartData)
              });
          }
      }
  }
</script>
```

---

_These sequence diagrams provide a detailed view of how each major workflow operates within the CCTV Dashboard system using Laravel Blade Templates and Alpine.js, ensuring proper understanding of data flow and system interactions._
